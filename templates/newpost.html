{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'assets/images/favicon.png' %}" rel="icon" type="image/png">
    <title>New Post</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'assets/css/icons.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/uikit.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/tailwind.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />


    <!-- leaflet js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <!-- leaflet draw plugin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

    <link rel="stylesheet"
        href="https://unpkg.com/@geoapify/leaflet-address-search-plugin@^1/dist/L.Control.GeoapifyAddressSearch.min.css" />
    <script
        src="https://unpkg.com/@geoapify/leaflet-address-search-plugin@^1/dist/L.Control.GeoapifyAddressSearch.min.js"></script>



    <style>
        #map {
            position: relative;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>

</head>

<body>

    <div class="container m-auto ">

        <h1 class="text-2xl leading-none text-gray-900 tracking-tight mt-3" style="text-align: center;"> New Post</h1>
        <br>
        <hr>
        <div>
            <div class="lg:grid-cols-3 mt-12" style="margin-left: 5%; margin-right: 5%;">

                <div class="bg-white rounded-md lg:shadow-lg shadow col-span-2">

                    <form action="/newpost" method="POST" id="my-form" enctype="multipart/form-data"
                        onkeydown="return event.key != 'Enter';">
                        {% csrf_token %}
                        <div class="grid grid-cols-2 gap-3 lg:p-6 p-4">

                            <div class="col-span-2">
                                <label for="">Title</label>
                                <input type="text" name="title" placeholder="Title" value=""
                                    class="shadow-none bg-gray-100">
                            </div>

                            <div class="col-span-2">
                                <div style="display: grid; grid-template-columns: auto 1fr; gap:10px ;"
                                    class="shadow-none bg-gray-100">
                                    <label for="date_option">Select a date format
                                        option:</label>
                                    <select id="date_option" name="date_option"
                                        style="width: min-content; height: min-content;">
                                        <option value="exact_date" selected>Exact Date</option>
                                        <option value="date_range">Range of Dates</option>
                                        <option value="decade">Decade</option>
                                    </select>
                                </div>
                                <div id="exact_date" class="shadow-none bg-gray-100"
                                    style="display:none; grid-template-columns: auto 1fr; gap:10px ; padding-top: 1%;">
                                    <label>Exact date:</label>
                                    <input type="date" name="exact_date" style="width: min-content; height:75%;">
                                </div>
                                <div id="date_range" class="shadow-none bg-gray-100"
                                    style="display:none; grid-template-columns: auto 1fr; gap:10px ; padding-top: 1%;">
                                    <label>Start date:</label>
                                    <input type="date" name="start_date" style="width: min-content; height:75%;">
                                    <label>End date:</label>
                                    <input type="date" name="end_date" style="width: min-content; height:75%;">
                                </div>
                                <div id="decade" class="shadow-none bg-gray-100"
                                    style="display:none; grid-template-columns: auto 1fr; gap:10px ; padding-top: 1%;">
                                    <label>Select decade:</label>
                                    <select name="decade" style="width: min-content; height:75%;">
                                        <option value="1920s">1920s</option>
                                        <option value="1930s">1930s</option>
                                        <option value="1940s">1940s</option>
                                        <option value="1940s">1950s</option>
                                        <option value="1940s">1960s</option>
                                        <option value="1940s">1970s</option>
                                        <option value="1940s">1980s</option>
                                        <option value="1940s">1990s</option>
                                        <option value="1940s">2000s</option>
                                        <option value="1940s">2010s</option>
                                        <option value="2020s">2020s</option>
                                    </select>
                                </div>
                            </div>
                            <script>
                                const select = document.getElementById('date_option');
                                const exactDateInput = document.getElementById('exact_date');
                                const dateRangeInput = document.getElementById('date_range');
                                const decadeInput = document.getElementById('decade');
                                if (select.value == "exact_date") {
                                    exactDateInput.style.display
                                        = 'grid';
                                }


                                select.addEventListener('change', function () {
                                    exactDateInput.style.display = 'none';
                                    dateRangeInput.style.display = 'none';
                                    decadeInput.style.display = 'none';
                                    const selectedOption = select.value;
                                    if (selectedOption === 'exact_date') {
                                        exactDateInput.style.display
                                            = 'grid';
                                    } else if (selectedOption === 'date_range') {
                                        dateRangeInput.style.display = 'grid';
                                    } else if (selectedOption === 'decade') {
                                        decadeInput.style.display = 'grid';
                                    }
                                });
                            </script>

                            <div class="col-span-2">
                                <label for="tags">Tags</label>
                                <input type="text" id="tags" name='tags' value='' placeholder="Add tags" />
                                <ul id="tags-list"></ul>
                            </div>

                            <div class="col-span-2">
                                <label for="">Files</label>
                                <!-- <img width="100" height="100" src="" /> -->
                                <input type="file" name="files" value="" multiple class="shadow-none bg-gray-100 mt-3">
                            </div>

                            <input type="hidden" name="type" id="type">
                            <input type="hidden" name="radius" id="radius">
                            <input type="hidden" name="coordinates" id="coordinates">
                            <input type="hidden" name="features" id="features">



                            <div class="col-span-2">
                                <label for="">Location</label>
                                <div id="map" style="height: 500px;">
                                    <script>
                                        var map = L.map('map').setView([0, 0], 1);
                                        var marker = null;
                                        var myAPIKey = "{{ myAPIKey }}";
                                        L.tileLayer('https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=ObmhcyIVPHpLuSAuaCKz', {

                                            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                                            apiKey: myAPIKey

                                        }).addTo(map);


                                        // Add Geoapify Address Search control
                                        const addressSearchControl = L.control.addressSearch(myAPIKey, {
                                            position: 'topright',
                                            resultCallback: (address) => {
                                                if (marker) {
                                                    marker.remove();
                                                }

                                                if (!address) {
                                                    return;
                                                }

                                                marker = L.marker([address.lat, address.lon]).addTo(map);

                                                if (address.bbox && address.bbox.lat1 !== address.bbox.lat2 && address.bbox.lon1 !== address.bbox.lon2) {
                                                    map.fitBounds([[address.bbox.lat1, address.bbox.lon1], [address.bbox.lat2, address.bbox.lon2]], { padding: [100, 100] })
                                                } else {
                                                    map.setView([address.lat, address.lon], 15);
                                                }
                                            },
                                            suggestionsCallback: (suggestions) => {
                                                console.log(suggestions);
                                            }
                                        });
                                        map.addControl(addressSearchControl);

                                        var drawnFeatures = new L.FeatureGroup();
                                        map.addLayer(drawnFeatures);
                                        var featureData = [];

                                        var drawControl = new L.Control.Draw({
                                            edit: {
                                                featureGroup: drawnFeatures,
                                                remove: false
                                            },
                                            draw: {
                                                polygon: {
                                                    shapeOptions: {
                                                        color: 'red',
                                                        repeatMode: false
                                                    },

                                                    drawError: {
                                                        color: 'red',
                                                        timeout: 1000,
                                                        repeatMode: false
                                                    },
                                                },
                                                polyline: {
                                                    shapeOptions: {
                                                        color: 'red',
                                                        repeatMode: false
                                                    },
                                                },
                                                rectangle: {
                                                    shapeOptions: {
                                                        color: 'red',
                                                        repeatMode: false
                                                    },
                                                },
                                                circle: {
                                                    shapeOptions: {
                                                        color: 'red',
                                                        repeatMode: false
                                                    },
                                                },
                                                marker: {
                                                    repeatMode: false
                                                }
                                            },
                                        });
                                        map.addControl(drawControl);

                                        map.on("draw:created", function (e) {
                                            var type = e.layerType;
                                            var layer = e.layer;
                                            console.log(e.layerType);



                                            if (type == 'circle') {
                                                var radius = layer.getRadius();
                                                console.log(radius);
                                                document.getElementById("radius").value = radius;
                                            }
                                            console.log(layer.toGeoJSON());
                                            layer.bindPopup('<p>' + JSON.stringify(layer.toGeoJSON()) + '</p>');
                                            var coordinates = JSON.stringify(layer.toGeoJSON().geometry.coordinates);
                                            var locationType = JSON.stringify(layer.toGeoJSON().geometry.type);
                                            document.getElementById("coordinates").value = coordinates;
                                            document.getElementById("type").value = locationType.replace(/'/g, '');
                                            drawnFeatures.addLayer(layer);

                                            var feature = layer.toGeoJSON();
                                            featureData.push(feature);
                                            var featureDataStr = JSON.stringify(featureData);

                                            document.getElementById("features").value = featureDataStr;

                                        });

                                        map.on("draw:edited", function (e) {
                                            var layers = e.layers;
                                            layers.eachLayer(function (layer) {
                                                console.log(layer)
                                                console.log(layer.toGeoJSON());
                                            })

                                        });

                                        map.on("draw:deleted", function (e) {
                                            var layers = e.layers;
                                            layers.eachLayer(function (layer) {
                                                console.log(layer)
                                                console.log(layer.toGeoJSON());
                                            })
                                        });

                                    </script>

                                </div>
                            </div>
                            <div class="col-span-2">
                                <label for="about">Content</label>
                                <textarea id="content" name="content" rows="20"
                                    class="shadow-none bg-gray-100"></textarea>
                            </div>
                        </div>

                        <div class="bg-gray-10 p-6 pt-0 flex justify-end space-x-3">
                            <button class="p-2 px-4 rounded bg-gray-50 text-red-500"> <a href="/">Cancel</a> </button>
                            <button type="submit" id="submit-button" class="button bg-blue-700"> Save </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
        <br>

    </div>

    </div>

    </div>

    </div>



    <!-- Scripts
    ================================================== -->
    <script src="{% static 'assets/js/tippy.all.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery-3.3.1.min.js' %}"></script>
    <script src="{% static 'assets/js/uikit.js' %}"></script>
    <script src="{% static 'assets/js/simplebar.js' %}"></script>
    <script src="{% static 'assets/js/custom.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.0/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/@yaireo/tagify"></script>
    <script src="https://unpkg.com/@yaireo/tagify@3.1.0/dist/tagify.polyfills.min.js"></script>
    <script>
        // The DOM element you wish to replace with Tagify
        var input = document.querySelector('input[name=tags]');

        // initialize Tagify on the above input node reference
        new Tagify(input)
    </script>

</body>

</html>